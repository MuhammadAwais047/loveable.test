<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>QuizForge – CCNA & OCR Quiz App</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
  <meta name="theme-color" content="#4c1d95">
  <meta name="apple-mobile-web-app-capable" content="yes">

  <!-- TESSERACT + PDF.JS (Critical for PDF OCR) -->
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5.1.0/dist/tesseract.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/pdfjs-dist@4.0.379/build/pdf.min.js"></script>
  <script>
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdn.jsdelivr.net/npm/pdfjs-dist@4.0.379/build/pdf.worker.min.js';
  </script>

  <style>
    :root { --p: #8b5cf6; --s: #ec4899; }
    .drop-zone { border: 3px dashed var(--p); transition: all 0.3s; border-radius: 1.5rem; }
    .drop-zone.dragover { background: rgba(139,92,246,0.15); transform: scale(1.02); }
    .bar { height: 10px; background: linear-gradient(90deg,var(--p),var(--s)); border-radius: 8px; }
    .glass { background: rgba(255,255,255,.08); backdrop-filter: blur(16px); border: 1px solid rgba(255,255,255,.15); }
    .section{display:none}.section.active{display:block}
    .correct{background:#10b981!important;color:white}.wrong{background:#ef4444!important;color:white}
    .exhibit-img{max-width:100%;border-radius:12px;margin:12px 0;box-shadow:0 4px 20px rgba(0,0,0,.4)}
    @media(max-width:768px){
      .text-6xl{font-size:2.5rem}.text-5xl{font-size:2rem}.text-4xl{font-size:1.8rem}
      .p-16{padding:2rem}.h-80{height:50vh}
    }
  </style>
</head>
<body class="bg-gradient-to-br from-purple-900 via-blue-900 to-indigo-900 min-h-screen text-white">

<button onclick="document.body.classList.toggle('dark-mode');this.innerHTML=document.body.classList.contains('dark-mode')?'Sun':'Moon'" 
  class="fixed top-4 right-4 z-50 text-2xl bg-white/10 border border-white/20 rounded-full p-3">Moon</button>

<header class="max-w-6xl mx-auto px-4 py-6 text-center">
  <h1 class="text-4xl font-bold bg-gradient-to-r from-purple-400 to-pink-400 bg-clip-text text-transparent">QuizForge</h1>
  <nav class="flex justify-center gap-4 mt-4 flex-wrap">
    <button onclick="s('home')" class="px-6 py-3 rounded-xl bg-white/10 border border-white/20 hover:bg-white/20">Home</button>
    <button onclick="s('upload')" class="px-6 py-3 rounded-xl bg-white/10 border border-white/20 hover:bg-white/20">Upload</button>
    <button onclick="s('play');startQuiz('ccna-200-301')" class="px-6 py-3 rounded-xl bg-white/10 border border-white/20 hover:bg-white/20">Play</button>
  </nav>
</header>

<main class="max-w-6xl mx-auto px-4 space-y-10">

  <!-- HOME -->
  <section id="home" class="section active text-center">
    <h2 class="text-5xl font-bold mb-4 bg-gradient-to-r from-purple-400 to-pink-400 bg-clip-text text-transparent">Turn Notes into Victory</h2>
    <p class="text-xl mb-6">Pakistan's #1 AI Quiz App • CCNA + Scanned Books</p>
    <button onclick="s('upload')" class="px-10 py-5 text-xl rounded-2xl bg-gradient-to-r from-purple-600 to-pink-600 hover:scale-110 transition font-bold">Upload Notes</button>
    <div class="glass rounded-3xl p-8 mt-10"><h3 class="text-3xl font-bold mb-6">My Decks</h3><div id="decks" class="grid md:grid-cols-3 gap-6"></div></div>
  </section>

  <!-- UPLOAD -->
  <section id="upload" class="section text-center space-y-8">
    <h2 class="text-5xl font-bold bg-gradient-to-r from-purple-400 to-pink-400 bg-clip-text text-transparent">Upload Your Notes</h2>
    <p class="text-xl">PDF • Photos • TXT • Urdu + English • 100% Private</p>
    <div id="drop" class="drop-zone glass p-16 cursor-pointer rounded-3xl">
      <i class="fas fa-brain text-9xl text-purple-400 mb-6"></i>
      <p class="text-3xl font-bold">Drop PDF / Photo Here</p>
      <input type="file" id="file" accept=".pdf,.jpg,.jpeg,.png,.txt" class="hidden">
    </div>
    <div id="result" class="hidden glass rounded-3xl p-8 space-y-6">
      <div class="flex justify-between items-center"><h3 class="text-2xl font-bold">AI Reading...</h3><i id="icon" class="fas fa-cog fa-spin text-4xl text-purple-400"></i></div>
      <div class="w-full bg-white/10 rounded-full h-10 overflow-hidden"><div id="bar" class="bar w-0"></div></div>
      <p id="msg" class="text-xl">Initializing AI Vision...</p>
      <textarea id="txt" class="w-full h-96 bg-white/5 border border-white/20 rounded-2xl p-6 text-lg" placeholder="Extracted text will appear here..."></textarea>
      <button id="gen" class="px-12 py-5 text-2xl rounded-2xl bg-gradient-to-r from-green-500 to-emerald-600 hover:scale-110 transition font-bold">Generate Quiz</button>
    </div>
  </section>

  <!-- PLAY -->
  <section id="play" class="section">
    <div class="glass rounded-3xl p-10 max-w-4xl mx-auto text-center">
      <img id="exhibit" class="exhibit-img hidden" src="" alt="Exhibit">
      <h2 id="qtext" class="text-3xl font-bold mb-8"></h2>
      <div id="opts" class="space-y-5"></div>
      <div class="flex justify-between mt-10">
        <button id="prev" class="px-8 py-6 rounded-xl bg-gradient-to-r from-gray-600 to-gray-700 font-bold text-xl hidden">Previous</button>
        <button id="next" class="px-12 py-6 rounded-xl bg-gradient-to-r from-purple-600 to-pink-600 font-bold text-xl">Next</button>
      </div>
      <div id="end" class="hidden mt-20">
        <h2 class="text-7xl font-bold mb-6 bg-gradient-to-r from-green-400 to-blue-500 bg-clip-text text-transparent">
          Score: <span id="sc">0</span>/<span id="tot">0</span>
        </h2>
        <button onclick="s('home')" class="px-16 py-8 text-3xl rounded-3xl bg-gradient-to-r from-purple-600 to-pink-600 font-bold hover:scale-110 transition">Back to Home</button>
      </div>
    </div>
  </section>

</main>

<script>
// Navigation
const s = x => document.querySelectorAll('.section').forEach(el => el.classList.toggle('active', el.id === x));

// CCNA Questions (Real 200-301 Style)
const ccnaDeck = [
  {q:"What does OSPF stand for?",o:["Open Shortest Path First","Onion Soup Protocol First","Open System Path Forward"],c:0},
  {q:"Default administrative distance of OSPF?",o:["90","100","110","120"],c:2},
  {q:"Which layer does a switch primarily operate?",o:["Layer 1","Layer 2","Layer 3","Layer 4"],c:1},
  {q:"What is the purpose of ARP?",o:["Resolve IP to MAC","Encrypt traffic","Route packets","Assign IP"],c:0},
  {q:"Which command shows the routing table?",o:["show ip route","show running-config","show interfaces","show version"],c:0}
];

let worker, currentDeck = [], qIndex = 0, score = 0;
let generatedDecks = []; // In-memory storage instead of localStorage

// Initialize Tesseract OCR (Urdu + English)
(async () => {
  try {
    worker = await Tesseract.createWorker('eng+urd', 1, {
      logger: m => {
        if (m.status === 'recognizing text') {
          document.getElementById('bar').style.width = (m.progress * 100) + '%';
          document.getElementById('msg').textContent = `AI Reading: ${Math.round(m.progress*100)}%`;
        }
      }
    });
    document.getElementById('msg').textContent = 'AI Vision Ready! Drop your file!';
  } catch (error) {
    document.getElementById('msg').textContent = 'AI Vision failed to initialize. Try refreshing.';
    console.error('Tesseract initialization error:', error);
  }
})();

// File Drop & Click
const dropZone = document.getElementById('drop');
dropZone.onclick = () => document.getElementById('file').click();
document.getElementById('file').onchange = e => e.target.files[0] && processFile(e.target.files[0]);

['dragover','dragenter'].forEach(ev => dropZone.addEventListener(ev, e => {e.preventDefault(); dropZone.classList.add('dragover')}));
['dragleave','drop'].forEach(ev => dropZone.addEventListener(ev, () => dropZone.classList.remove('dragover')));
dropZone.addEventListener('drop', e => {
  e.preventDefault();
  if (e.dataTransfer.files.length) processFile(e.dataTransfer.files[0]);
});

// Process File (PDF + Images + TXT)
async function processFile(file) {
  document.getElementById('result').classList.remove('hidden');
  let fullText = '';

  if (file.name.endsWith('.txt')) {
    fullText = await file.text();
  } 
  else if (file.type.startsWith('image/') || file.name.match(/\.(pdf|jpe?g|png)$/i)) {
    document.getElementById('msg').textContent = 'Processing document...';
    document.getElementById('icon').className = 'fas fa-cog fa-spin text-4xl text-purple-400';

    try {
      if (file.name.endsWith('.pdf')) {
        const arrayBuffer = await file.arrayBuffer();
        const pdf = await pdfjsLib.getDocument({data: arrayBuffer}).promise;
        for (let i = 1; i <= pdf.numPages; i++) {
          const page = await pdf.getPage(i);
          const viewport = page.getViewport({scale: 2.0});
          const canvas = document.createElement('canvas');
          canvas.width = viewport.width; canvas.height = viewport.height;
          await page.render({canvasContext: canvas.getContext('2d'), viewport}).promise;
          const result = await worker.recognize(canvas.toDataURL());
          fullText += result.data.text + '\n\n';
          document.getElementById('bar').style.width = ((i/pdf.numPages)*100) + '%';
        }
      } else {
        const result = await worker.recognize(URL.createObjectURL(file));
        fullText = result.data.text;
      }
    } catch (error) {
      console.error('File processing error:', error);
      fullText = 'Error processing file. Please try a different file or format.';
    }
  }

  document.getElementById('txt').value = fullText || 'No text found. Try clearer image.';
  document.getElementById('bar').style.width = '100%';
  document.getElementById('msg').textContent = 'Done! Click Generate Quiz';
  document.getElementById('icon').className = 'fas fa-check-circle text-green-400 text-5xl';
}

// Generate Quiz from Text
document.getElementById('gen').onclick = () => {
  const text = document.getElementById('txt').value.trim();
  if (!text || text.includes('Error processing file') || text === 'No text found. Try clearer image.') {
    alert('No valid text to generate quiz!');
    return;
  }

  const paragraphs = text.split('\n\n').filter(p => p.length > 50);
  currentDeck = paragraphs.slice(0, 25).map((para, i) => ({
    q: para.split('\n')[0].slice(0, 180) + (para.length > 180 ? '...' : '') + '?',
    o: ['Correct Answer', 'Wrong Option A', 'Wrong Option B', 'Wrong Option C'],
    c: 0
  }));

  // Save deck in memory
  const deckName = `Deck ${new Date().toLocaleDateString('en-GB')}`;
  const deckId = 'deck_' + Date.now();
  generatedDecks.push({id: deckId, name: deckName, questions: currentDeck});
  loadDecks();
  startQuiz(deckId);
};

// Start CCNA Quiz
function startQuiz(deckId) {
  if (deckId === 'ccna-200-301') {
    currentDeck = ccnaDeck;
    playQuiz('Cisco CCNA 200-301 Practice');
  } else {
    const deck = generatedDecks.find(d => d.id === deckId);
    if (deck) {
      currentDeck = deck.questions;
      playQuiz(deck.name);
    }
  }
}

function playQuiz(title = 'Quiz') {
  document.getElementById('qtext').textContent = title;
  qIndex = 0; score = 0;
  showQuestion();
  s('play');
}

function showQuestion() {
  if (qIndex >= currentDeck.length) {
    document.getElementById('end').classList.remove('hidden');
    document.getElementById('sc').textContent = score;
    document.getElementById('tot').textContent = currentDeck.length;
    document.getElementById('next').classList.add('hidden');
    document.getElementById('prev').classList.add('hidden');
    return;
  }

  const qq = currentDeck[qIndex];
  document.getElementById('qtext').textContent = `Question ${qIndex + 1}: ${qq.q}`;
  document.getElementById('opts').innerHTML = qq.o.map((opt, i) => `
    <button onclick="answer(${i},${qq.c})" class="w-full p-8 text-left rounded-3xl glass hover:bg-white/10 transition text-xl font-medium">
      ${String.fromCharCode(65 + i)}) ${opt}
    </button>
  `).join('');

  // Update navigation buttons
  const prevBtn = document.getElementById('prev');
  const nextBtn = document.getElementById('next');
  prevBtn.classList.toggle('hidden', qIndex === 0);
  nextBtn.classList.toggle('hidden', qIndex >= currentDeck.length - 1);
  document.getElementById('end').classList.add('hidden');
}

window.answer = (selected, correct) => {
  const buttons = document.querySelectorAll('#opts button');
  buttons.forEach((btn, i) => {
    btn.disabled = true;
    if (i === correct) {
      btn.classList.add('correct');
    } else if (i === selected && selected !== correct) {
      btn.classList.add('wrong');
    }
  });
  
  if (selected === correct) score++;
  qIndex++;
  
  setTimeout(() => {
    if (qIndex < currentDeck.length) {
      showQuestion();
    } else {
      showQuestion(); // This will show the end screen
    }
  }, 1500);
};

document.getElementById('next').onclick = () => { 
  qIndex++; 
  showQuestion(); 
};

document.getElementById('prev').onclick = () => { 
  qIndex--; 
  showQuestion(); 
};

// Load Saved Decks on Home
function loadDecks() {
  const container = document.getElementById('decks');
  
  container.innerHTML = generatedDecks.length ? generatedDecks.map(deck => {
    return `
      <div onclick="startQuiz('${deck.id}')" class="glass rounded-3xl p-8 cursor-pointer hover:scale-105 transition text-center">
        <h3 class="text-2xl font-bold text-purple-300">${deck.name}</h3>
        <p class="text-xl mt-4">${deck.questions.length} Questions</p>
      </div>
    `;
  }).join('') : '<p class="text-xl text-white/60">No custom decks yet!</p>';
}

// Initialize with CCNA deck visible
loadDecks();
</script>
</body>
</html>

